# 階層型在庫管理システム - 進捗管理

## プロジェクト概要

**プロジェクト名**: 階層型在庫管理システム
**開始日**: 2025-11-13
**要件定義書**: [inventory-requirements.md](./inventory-requirements.md)

---

## Phase進捗

### Phase 1: 要件定義 ✅
- [x] Step#1: 得たい成果の精密な特定
- [x] Step#2: 実現可能性調査
- [x] Step#3: 認証・権限設計
- [x] Step#4: ページリスト作成
- [x] Step#5: 技術スタック最終決定
- [x] Step#6: 外部API最終決定
- [x] Step#7: 要件定義書作成
- [x] Step#8: SCOPE_PROGRESS更新
- [x] Step#9: CLAUDE.md生成

**完了日**: 2025-11-13

---

### Phase 2: Git/GitHub管理 ✅
- [x] リポジトリ作成
- [x] 初期コミット
- [x] README作成

**完了日**: 2025-11-13

---

### Phase 3: フロントエンド基盤 ✅
- [x] Reactプロジェクト作成（Vite）
- [x] MUI v6セットアップ
- [x] ルーティング設定
- [x] 状態管理設定（Zustand, React Query）
- [x] 全12ページ実装完了
- [x] 認証システム実装（AuthContext）
- [x] テーマ設定完了

**完了日**: 2025-11-15

---

### Phase 4: バックエンド基盤 ✅
- [x] Node.js + Expressプロジェクト作成
- [x] Prismaセットアップ
- [x] Neonデータベース接続
- [x] 認証ミドルウェア実装

**完了日**: 2025-11-17

---

### Phase 5: データベース設計 ✅
- [x] Prismaスキーマ作成
- [x] マイグレーション実行
- [x] 初期データ投入

**完了日**: 2025-11-17

---

### Phase 6: 認証機能 ✅
- [x] ログインAPI実装
- [x] セッション管理
- [x] ログアウトAPI実装
- [x] セッション検証API実装

**完了日**: 2025-11-17

---

### Phase 7: バックエンドAPI実装 ✅
- [x] カテゴリー管理API（4エンドポイント）
- [x] ジャンル管理API（4エンドポイント）
- [x] パーツ管理API（5エンドポイント）
- [x] 検索機能API（2エンドポイント）
- [x] 統計機能API（1エンドポイント）
- [x] エクスポート機能API（3エンドポイント）
- [x] 画像管理API（2エンドポイント）
- [x] アカウント設定API（2エンドポイント）

**完了日**: 2025-11-17
**総エンドポイント数**: 26

---

### Phase 8: API統合 ✅（完全完了）
- [x] API基盤レイヤー構築（client.ts, types.ts, endpoints.ts, index.ts）
- [x] 全APIサービス実装（9ファイル、26エンドポイント対応）
  - auth.ts（ログイン、ログアウト、セッション）
  - categories.ts（カテゴリーCRUD）
  - genres.ts（ジャンルCRUD）
  - parts.ts（パーツCRUD、在庫更新）
  - search.ts（収納ケース、品番検索）
  - stats.ts（統計データ）
  - images.ts（画像アップロード、削除）
  - export.ts（CSV/PDFエクスポート、CSVインポート）
  - account.ts（メール変更、パスワード変更）
- [x] 全12ページAPI統合完了
  - P-001（ログイン）- AuthContext実API統合
  - P-002（カテゴリー選択）- categoriesApi統合
  - P-003（ジャンル一覧）- genresApi統合
  - P-004（パーツリスト）- partsApi統合
  - P-005（検索）- searchApi統合
  - A-001（ダッシュボード）- statsApi統合
  - A-002（カテゴリー管理）- CRUD + 楽観的更新
  - A-003（ジャンル管理）- CRUD + 画像管理 + 楽観的更新
  - A-004（パーツ管理）- CRUD + 在庫更新 + エクスポート/インポート
  - A-005（表示設定）- 実装済み
  - A-006（アカウント設定）- accountApi統合
  - CategoryListPage - categoriesApi統合
- [x] React Query統合（キャッシング、楽観的更新）
- [x] モックデータ完全削除（partsData.ts, partsStore.ts削除）
- [x] TypeScript型チェック完了（エラー0件）
- [x] ビルド成功（dist生成完了）

**完了日**: 2025-11-17
**総実装ファイル数**: 22ファイル（API 13 + ページ 9）
**総コード行数**: 約1,200行（APIレイヤー）
**削除コード行数**: 約300行（モックデータ削除）

---

### Phase 9: 品質チェックとE2Eテスト ✅
- [x] TypeScriptエラー修正（Backend 18件 → 0件）
- [x] ビルドエラー修正（Frontend ビルド成功）
- [x] CORS設定修正（3589 → 3590）
- [x] 画像管理機能確認（Cloudinary統合完了）
- [x] エクスポート/インポート機能確認（CSV/PDF実装完了）
- [x] E2Eテスト実施（24テスト、22成功、成功率91.7%）
- [x] テストレポート生成（E2E_TEST_REPORT.md、e2e-test.sh）

**完了日**: 2025-11-17
**品質指標**:
- TypeScriptエラー: 0件（Frontend + Backend）
- ビルド成功: ✅
- E2E成功率: 91.7%（22/24テスト成功）
- API実装率: 100%（26/26エンドポイント）

---

### Phase 10: 本番デプロイ準備 ✅
- [x] Dockerfile作成
- [x] 環境変数設定ガイド作成
- [x] デプロイマニュアル作成（DEPLOYMENT_MANUAL.md）
- [x] .dockerignore作成
- [x] package.json本番用スクリプト追加

**完了日**: 2025-11-17

---

### Phase 11: 本番デプロイ ✅
- [x] Neonデータベース本番環境設定
- [x] Google Cloud Run デプロイ（東京リージョン）
- [x] Vercel フロントエンドデプロイ
- [x] 環境変数設定完了
- [x] 本番環境動作確認

**完了日**: 2025-11-18
**本番URL**:
- Frontend: https://frontend-i32xqp6tw-tatsuyas-projects-20cab125.vercel.app
- Backend: https://inventory-backend-72579044624.asia-northeast1.run.app

---

### Phase 12: UI/UX改善と機能拡張 ✅（完了）

### Phase 13: 展開図管理機能追加 ✅（完了）
- [x] データベーススキーマ確認（DiagramImageテーブル既存）
- [x] バックエンドAPI実装
  - diagramImageService.ts作成（CRUD操作）
  - diagramImageController.ts作成（リクエストハンドラー）
  - diagramImage.tsルート作成
  - index.tsにルート登録
- [x] フロントエンドAPI実装
  - types/index.tsにDiagramImage型追加
  - services/api/diagramImages.ts作成
  - services/api/index.tsにエクスポート追加
- [x] 管理パーツページに展開図アップロード機能追加
  - 展開図アップロードUIの追加
  - Cloudinaryへのアップロード処理
  - 展開図プレビュー表示
  - 展開図削除機能
- [x] PartsListPageで展開図を正しく表示
  - DiagramImage APIから展開図取得
  - Genre.imageUrlではなくDiagramImage.imageUrlを使用
- [x] Unit Code表示の動的化（PartsListPage）

**開始日**: 2025-11-27
**完了日**: 2025-11-27
**進捗**: 100%（全機能実装完了）

---

### Phase 12: UI/UX改善と機能拡張 ✅（完了）
- [x] ドラッグ&ドロップ並び替え機能実装（Genre、Unit、Parts）
- [x] 並び順の条件付き有効化
  - Genre: カテゴリー選択時のみ
  - Unit: ジャンル選択時のみ
  - Parts: ユニット選択時のみ
- [x] カスケードドロップダウン実装
  - Unit管理: ジャンルはカテゴリー選択後に有効化
  - Parts管理: ジャンル→ユニットの階層選択
- [x] パーツ管理のユニット番号編集可能化
- [x] パーツ管理テーブルヘッダー更新（二言語表記）
- [x] ユニット番号名称変更（ユニット個別番号/Unit Individual No.）
- [x] パーツ管理に発注日・入荷予定日フィールド追加
- [x] パーツ管理に備考欄追加
- [x] 日付フォーマット修正（ISO形式 → YYYY-MM-DD表示）
- [x] テーブルヘッダー中央揃え統一
- [x] データベーススキーマ拡張（quantity, price フィールド追加）
- [x] バックエンドAPI更新（quantity, price 対応）
- [x] フロントエンド型定義更新（quantity, price 追加）
- [x] ユニットフィルタリング修正（App.tsx ルートパラメータ: unitNumber → unitId）
- [x] ユニット番号表示追加（管理ページ・一般ページ両方）
- [x] バックエンドpartService更新（unit relation include追加）
- [x] パーツ管理ページ完全更新
  - ジャンル名列 → 数量列に変更
  - 在庫数量と収納ケースの間に価格列追加
  - State変数、フォームハンドラ更新
  - 在庫数量フィールド追加（ダイアログ内、+/-ボタン付き）
  - 数量フィールドに+/-ボタン追加
  - 価格フィールドからボタン削除
  - ブラウザデフォルトの数値スピンボタン非表示化（CSS）
  - 在庫数量0の時のみ赤字表示（条件付きスタイリング）
- [x] パーツ管理ダイアログフォーム更新（quantity, price入力欄追加）
- [x] 一般ページ（PartsListPage）更新
  - ジャンル名列 → 数量列に変更
  - 価格列追加
  - テーブル表示更新

**開始日**: 2025-11-22
**完了日**: 2025-11-27
**進捗**: 100%（全タスク完了）

---

## ページ管理表

| ID | ページ名 | ルート | 権限レベル | 機能 | 着手 | 完了 |
|----|---------|-------|----------|------|------|------|
| P-001 | ログインページ | `/login` | ゲスト | ログイン認証 | [x] | [x] |
| P-002 | カテゴリー選択ページ | `/categories` | 管理者 | カテゴリー一覧表示、検索ボタン | [x] | [x] |
| P-003 | ジャンル一覧ページ | `/categories/:id/genres` | 管理者 | ジャンル一覧表示（画像付き） | [x] | [x] |
| P-004 | パーツリストページ | `/genres/:id/parts` | 管理者 | 展開図+パーツ一覧表示 | [x] | [x] |
| P-005 | 検索ページ | `/search` | 管理者 | 収納ケース番号/品番検索 | [x] | [x] |
| A-001 | 管理ダッシュボード | `/admin` | 管理者 | 統計表示、クイックアクセス | [x] | [x] |
| A-002 | カテゴリー管理ページ | `/admin/categories` | 管理者 | カテゴリー追加/編集/削除 | [x] | [x] |
| A-003 | ジャンル管理ページ | `/admin/genres` | 管理者 | ジャンル追加/編集/削除/画像管理 | [x] | [x] |
| A-004 | パーツリスト管理ページ | `/admin/parts` | 管理者 | パーツ追加/編集/削除/一括操作/CSV/PDF出力 | [x] | [x] |
| A-005 | 表示設定ページ | `/admin/settings/display` | 管理者 | 画像表示切り替え、画像位置選択 | [x] | [x] |
| A-006 | アカウント設定ページ | `/admin/settings/account` | 管理者 | ID/パスワード変更 | [x] | [x] |

---

## 主要マイルストーン

- [x] **2025-11-13**: Phase 1 完了（要件定義）
- [x] **2025-11-13**: Phase 2 完了（Git/GitHub管理）
- [x] **2025-11-15**: Phase 3 完了（フロントエンド基盤・全ページ実装）
- [x] **2025-11-17**: Phase 4 完了（バックエンド基盤）
- [x] **2025-11-17**: Phase 5 完了（データベース設計）
- [x] **2025-11-17**: Phase 6 完了（認証機能）
- [x] **2025-11-17**: Phase 7 完了（バックエンドAPI実装・26エンドポイント）
- [x] **2025-11-17**: Phase 8 完了（API統合）← フロントエンドとバックエンド完全統合
- [x] **2025-11-17**: Phase 9 完了（品質チェックとE2Eテスト）← 91.7%成功率達成
- [x] **2025-11-17**: Phase 10 完了（本番デプロイ準備）
- [x] **2025-11-18**: Phase 11 完了（本番デプロイ成功）← MVP達成 🎉
- [x] **2025-11-27**: Phase 12 完了（UI/UX改善と機能拡張）← 100%完了 ✅
- [x] **2025-11-27**: Phase 13 完了（展開図管理機能追加）← 100%完了 🎉
- [ ] **次のステップ**: 本番環境へデプロイ

---

## 🎯 現在の状態

**フロントエンド**: ✅ デプロイ済み（Vercel）
**バックエンド**: ✅ デプロイ済み（Google Cloud Run - 東京リージョン）
**データベース**: ✅ 本番稼働中（Neon PostgreSQL）
**品質チェック**: ✅ 完了（TypeScriptエラー0件、E2E成功率91.7%）
**画像管理**: ✅ 完了（Cloudinary統合済み）
**エクスポート**: ✅ 完了（CSV/PDF実装済み）
**本番環境**: ✅ 稼働中

**現在の状態**: Phase 12完了 ✅
- ✅ データベーススキーマ拡張（quantity, price）
- ✅ バックエンドAPI更新完了
- ✅ パーツ管理ページ完全更新完了（在庫数量フィールド、条件付き赤字表示等）
- ✅ パーツ管理ダイアログ更新完了（quantity, price入力欄、+/-ボタン）
- ✅ 一般ページ（PartsListPage）更新完了（数量・価格列追加）

**次のアクション**:
1. ユーザーからの表示変更要望の確認
2. 追加の調整実施（必要に応じて）
3. 本番環境へデプロイ

**Phase 12で実装された機能（2025-11-22〜2025-11-27）**:
- ドラッグ&ドロップ並び替え機能（Genre、Unit、Parts）
- カスケードドロップダウン実装（階層選択）
- ユニットフィルタリング修正（unitNumber → unitId）
- ユニット番号表示追加（管理・一般ページ）
- 在庫数量管理機能実装（+/-ボタン、自動反映）
- 在庫数量0の条件付き赤字表示
- 数量・価格フィールド追加（全ページ対応）
- 数値入力フィールドのブラウザスピンボタン非表示化
- テーブルヘッダー二言語表記対応
- 発注日・入荷予定日フィールド追加

---

## 技術スタック

### フロントエンド
- React 18
- TypeScript 5
- MUI v6
- React Router v6
- Zustand
- React Query
- Vite 5
- react-pdf
- Papa Parse

### バックエンド
- Node.js 20+ (TypeScript 5)
- Express.js
- Prisma ORM
- bcrypt
- express-session
- multer

### インフラ
- Database: PostgreSQL 15+ (Neon)
- Image Storage: Cloudinary
- Frontend Hosting: Vercel
- Backend Hosting: Google Cloud Run

---

## 外部サービス

| サービス | 用途 | 状態 |
|---------|------|------|
| Cloudinary | 画像・PDF保存 | ⏳ 未登録 |
| Neon | PostgreSQLデータベース | ⏳ 未登録 |

---

**最終更新日**: 2025-11-27（Phase 12完了 - UI/UX改善100%）

---

## バックエンド実装計画

### 📊 実装計画概要

| 項目 | 内容 |
|------|------|
| **総エンドポイント数** | 26 |
| **垂直スライス数** | 10（Slice 0〜7） |
| **並列実装可能グループ** | 2グループ（Week 5, Week 6） |
| **推定工数（直列）** | 8週間 |
| **推定工数（並列）** | 8週間 |
| **短縮効果** | なし（クリティカルパス上のSlice 0-4が長いため） |

---

### 🎯 垂直スライス実装順序

| 順序 | スライス名 | 主要機能 | エンドポイント数 | 依存スライス | 完了 |
|------|-----------|---------|--------------|-------------|------|
| **0** | データベース基盤 | Prisma, スキーマ定義, マイグレーション | 0 | なし | [x] |
| **1** | 認証基盤 | ログイン/ログアウト/セッション管理 | 3 | Slice 0 | [x] |
| **2** | カテゴリー管理 | カテゴリーCRUD | 4 | Slice 1 | [x] |
| **3** | ジャンル管理 | ジャンルCRUD、画像管理 | 4 | Slice 1, 2 | [x] |
| **4** | パーツ管理 | パーツCRUD、在庫数更新 | 5 | Slice 1, 3 | [x] |
| **5-A** | 検索機能 | 収納ケース番号検索、品番検索 | 2 | Slice 4 | [x] |
| **5-B** | 統計機能 | 統計情報取得 | 1 | Slice 2, 3, 4 | [x] |
| **6-A** | エクスポート機能 | CSV/PDFエクスポート、CSV一括インポート | 3 | Slice 4 | [x] |
| **6-B** | 画像管理 | 画像アップロード、画像削除 | 2 | Slice 1, Cloudinary | [x] |
| **7** | アカウント設定 | メールアドレス変更、パスワード変更 | 2 | Slice 1 | [x] |

**注意**: 番号-アルファベット表記は並列実装可能を示す（例: 5-A, 5-Bは同時実装可能）

---

### 📝 エンドポイント実装タスクリスト

#### Slice 0: データベース基盤 ✅

| タスク | 説明 | 完了 |
|--------|------|------|
| 0.1 | Prismaスキーマ定義（Admin, Category, Genre, Part, PartMaster, DiagramImage） | [x] |
| 0.2 | データベースマイグレーション実行（`npx prisma db push`） | [x] |
| 0.3 | 開発用シードデータ作成 | [x] |
| 0.4 | エラーハンドリングミドルウェア作成 | [x] |
| 0.5 | バリデーションヘルパー作成 | [x] |

#### Slice 1: 認証基盤 ✅

| タスク | エンドポイント | メソッド | 完了 |
|--------|--------------|---------|------|
| 1.1 | /api/auth/login | POST | [x] |
| 1.2 | /api/auth/logout | POST | [x] |
| 1.3 | /api/auth/session | GET | [x] |
| 1.4 | bcrypt実装 | - | [x] |
| 1.5 | express-session実装 | - | [x] |
| 1.6 | セッション検証ミドルウェア作成（requireAuth） | - | [x] |

#### Slice 2: カテゴリー管理 ✅

| タスク | エンドポイント | メソッド | 完了 |
|--------|--------------|---------|------|
| 2.1 | /api/categories | GET | [x] |
| 2.2 | /api/admin/categories | POST | [x] |
| 2.3 | /api/admin/categories/:id | PUT | [x] |
| 2.4 | /api/admin/categories/:id | DELETE | [x] |
| 2.5 | カテゴリー名ユニーク制約チェック | - | [x] |

#### Slice 3: ジャンル管理 ✅

| タスク | エンドポイント | メソッド | 完了 |
|--------|--------------|---------|------|
| 3.1 | /api/categories/:id/genres | GET | [x] |
| 3.2 | /api/admin/genres | POST | [x] |
| 3.3 | /api/admin/genres/:id | PUT | [x] |
| 3.4 | /api/admin/genres/:id | DELETE | [x] |
| 3.5 | ジャンル画像URL保存処理 | - | [x] |

#### Slice 4: パーツ管理 ✅

| タスク | エンドポイント | メソッド | 完了 |
|--------|--------------|---------|------|
| 4.1 | /api/genres/:id/parts | GET | [x] |
| 4.2 | /api/admin/parts | POST | [x] |
| 4.3 | /api/admin/parts/:id | PUT | [x] |
| 4.4 | /api/admin/parts/:id | DELETE | [x] |
| 4.5 | /api/admin/parts/:partNumber/stock | PUT | [x] |
| 4.6 | トランザクション実装（在庫数更新） | - | [x] |
| 4.7 | PartMaster自動作成・更新ロジック | - | [x] |

#### Slice 5-A: 検索機能 ✅

| タスク | エンドポイント | メソッド | 完了 |
|--------|--------------|---------|------|
| 5A.1 | /api/search/by-storage-case | GET | [x] |
| 5A.2 | /api/search/by-part-number | GET | [x] |
| 5A.3 | 横断検索クエリ実装 | - | [x] |

#### Slice 5-B: 統計機能 ✅

| タスク | エンドポイント | メソッド | 完了 |
|--------|--------------|---------|------|
| 5B.1 | /api/admin/stats | GET | [x] |
| 5B.2 | 統計計算ロジック実装 | - | [x] |

#### Slice 6-A: エクスポート機能 ✅

| タスク | エンドポイント | メソッド | 完了 |
|--------|--------------|---------|------|
| 6A.1 | /api/admin/genres/:id/export/csv | GET | [x] |
| 6A.2 | /api/admin/genres/:id/export/pdf | GET | [x] |
| 6A.3 | /api/admin/genres/:id/import/csv | POST | [x] |
| 6A.4 | Papa Parse実装（CSVエクスポート） | - | [x] |
| 6A.5 | PDFKit実装（PDFエクスポート） | - | [x] |
| 6A.6 | CSV一括インポート処理（トランザクション） | - | [x] |

#### Slice 6-B: 画像管理 ✅

| タスク | エンドポイント | メソッド | 完了 |
|--------|--------------|---------|------|
| 6B.1 | /api/admin/images/upload | POST | [x] |
| 6B.2 | /api/admin/images/:id | DELETE | [x] |
| 6B.3 | Cloudinaryセットアップ | - | [x] |
| 6B.4 | multer実装（ファイルアップロード） | - | [x] |
| 6B.5 | 画像差し替え時の旧画像削除処理 | - | [x] |

#### Slice 7: アカウント設定 ✅

| タスク | エンドポイント | メソッド | 完了 |
|--------|--------------|---------|------|
| 7.1 | /api/admin/account/email | PUT | [x] |
| 7.2 | /api/admin/account/password | PUT | [x] |
| 7.3 | パスワード検証ロジック | - | [x] |

---

### ⏱️ 並列実装スケジュール

```
Week 0: |====データベース基盤====|
Week 1: |====認証基盤（3エンドポイント）====|
Week 2: |====カテゴリー管理（4エンドポイント）====|
Week 3: |====ジャンル管理（4エンドポイント）====|
Week 4: |====パーツ管理（5エンドポイント）====|
Week 5: |====検索機能（2エンドポイント）====|
        |===統計機能（1エンドポイント）===| ← 並列実装
Week 6: |==エクスポート機能（3エンドポイント）==|
        |===画像管理（2エンドポイント）===| ← 並列実装
        |===アカウント設定（2エンドポイント）===| ← 並列実装
Week 7: |====統合テスト・最終調整====|
```

---

### 🎯 クリティカルパス

最短実装パス（並列実装を最大化した場合）:

1. **Week 0**: Slice 0（データベース基盤） - 1週間
2. **Week 1**: Slice 1（認証基盤） - 1週間
3. **Week 2**: Slice 2（カテゴリー管理） - 1週間
4. **Week 3**: Slice 3（ジャンル管理） - 1週間
5. **Week 4**: Slice 4（パーツ管理） - 1.5週間
6. **Week 5**: Slice 5-A + 5-B（検索 + 統計） - 1週間（並列実装）
7. **Week 6**: Slice 6-A + 6-B + 7（エクスポート + 画像 + アカウント） - 1.5週間（並列実装）

**合計**: 8週間

---

### 🚀 バックエンド実装への引き継ぎ事項

#### 実装順序の厳守事項
1. **Slice 0（データベース基盤）を必ず最初に完成させる**
2. **番号-アルファベット表記（5-A, 5-B等）は並列実装可能**
3. **スライスの依存関係を確認し、前提条件を満たす**

#### 並列実装時の注意事項
- データベースマイグレーションの競合を避ける
- 共通ユーティリティは最初に作成（Week 0）
- 型定義（frontend/src/types/index.ts と backend/src/types/index.ts）の同期を忘れない

#### トランザクション必須の操作
- 在庫数更新（PartMaster更新）
- CSV一括インポート（複数パーツ作成 + PartMaster更新）
- ジャンル削除（関連パーツ・画像も削除）

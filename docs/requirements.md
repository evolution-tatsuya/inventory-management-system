# 階層型在庫管理システム - 要件定義書

## 要件定義の作成原則
- **「あったらいいな」は絶対に作らない**
- **拡張可能性のための余分な要素は一切追加しない**
- **将来の「もしかして」のための準備は禁止**
- **今、ここで必要な最小限の要素のみ**

---

## 1. プロジェクト概要

### 1.1 成果目標
**「ログイン認証付き3階層在庫管理システム。カテゴリー→ジャンル→パーツの階層構造で在庫を管理し、展開図とパーツ画像を表示。品番/収納場所で横断検索、発注入荷管理、PDF/CSVエクスポート、サイドバー式管理画面を備え、将来的にマルチテナント対応可能なシステム」**

### 1.2 成功指標

#### 定量的指標
1. **検索時間**: 品番入力から検索結果表示まで5秒以内
2. **編集作業時間**: パーツ情報の追加・修正が1件あたり1分以内で完了
3. **データ精度**: 在庫数と実在庫の一致率95%以上を維持
4. **収納場所検索**: 収納ケース番号からパーツ一覧を10秒以内に表示
5. **エクスポート速度**: 展開図付きPDF出力が30秒以内に完了

#### 定性的指標
1. **直感的な操作性**: 画像付きボタンで視覚的に目的のジャンル・パーツにたどり着ける
2. **管理のしやすさ**: サイドバー+タブ構成の管理画面で、画像含む全要素の編集がスムーズ
3. **視認性の高さ**: ジャンル画像・展開図・パーツ画像で視覚的に在庫を把握できる
4. **検索の網羅性**: 同じパーツが複数ジャンルで使われている場合も一度に把握できる
5. **発注管理**: 発注日・入荷予定日・備考で在庫補充がスムーズに行える
6. **データ活用性**: PDF/CSVで出力し、印刷や共有が簡単にできる

---

## 2. システム全体像

### 2.1 主要機能一覧
- **3階層構造**: カテゴリー → ジャンル → パーツリスト
- **画像管理**: ジャンル画像、展開図（大）、パーツ画像（小）、PDF表示対応
- **横断検索**: 収納ケース番号検索、品番検索（複数ジャンルにまたがる検索）
- **在庫管理**: 同一品番の在庫数自動同期（カテゴリー内のみ）
- **発注管理**: 発注日、入荷予定日、備考管理
- **エクスポート**: CSV、PDF（展開図+一覧表）
- **一括操作**: CSV一括インポート、チェックボックス選択式一括削除

### 2.2 ユーザーロールと権限

#### 現在（個人利用版）
- **管理者**: システムの全機能にアクセス可能（ログイン必須）

#### 将来（ビジネス版）
- **マルチテナント対応**: 1アカウント = 1独立した在庫データ
- **テナント分離**: データベース行レベルでテナントIDによる分離

### 2.3 認証・認可要件
- **認証方式**: bcrypt + express-session
- **セキュリティレベル**: 中レベル（個人データ保護）
- **管理機能**: カテゴリー、ジャンル、パーツ、画像の全管理 + ID/パスワード変更

---

## 3. ページ詳細仕様

### 3.1 P-001: ログインページ

#### 目的
管理者認証を行い、セキュアなアクセス制御を実現する

#### 主要機能
- ID（メールアドレス）とパスワード入力
- ログインボタン
- セッション管理

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 作成 | ログイン | メールアドレス、パスワード | セッション作成、カテゴリー選択ページへリダイレクト |

#### 処理フロー
1. ユーザーがメールアドレスとパスワードを入力
2. サーバーがbcryptでパスワードを検証
3. 認証成功 → セッション作成、カテゴリー選択ページへ遷移
4. 認証失敗 → エラーメッセージ表示

#### データ構造（概念）
```yaml
Admin:
  識別子: id (自動生成)
  基本情報:
    - email（必須、ユニーク）
    - passwordHash（必須、bcryptハッシュ）
  メタ情報:
    - 作成日時
    - 更新日時
```

---

### 3.2 P-002: カテゴリー選択ページ

#### 目的
大カテゴリー（GT3-048など）を選択し、目的のジャンル一覧へ誘導する

#### 主要機能
- カテゴリーボタン一覧表示
- 検索ボタン（収納ケース番号/品番検索ページへ遷移）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | カテゴリー一覧取得 | なし | カテゴリー配列 |
| 遷移 | カテゴリー選択 | カテゴリーID | ジャンル一覧ページへ遷移 |
| 遷移 | 検索ボタンクリック | なし | 検索ページへ遷移 |

#### 処理フロー
1. ページ読み込み時、カテゴリー一覧を取得
2. カテゴリーボタンを表示
3. ユーザーがカテゴリーをクリック → ジャンル一覧ページへ遷移
4. ユーザーが検索ボタンをクリック → 検索ページへ遷移

#### データ構造（概念）
```yaml
Category:
  識別子: id (自動生成)
  基本情報:
    - name（必須、ユニーク）例: GT3-048
  メタ情報:
    - 作成日時
    - 更新日時
  関連:
    - Genre（1対多）
```

---

### 3.3 P-003: ジャンル一覧ページ

#### 目的
選択されたカテゴリー内のジャンルを視覚的に表示し、パーツリストへ誘導する

#### 主要機能
- ジャンルボタン一覧表示（画像付き）
- 各ジャンルボタンに画像を表示

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | ジャンル一覧取得 | カテゴリーID | ジャンル配列（画像URL含む） |
| 遷移 | ジャンル選択 | ジャンルID | パーツリストページへ遷移 |

#### 処理フロー
1. カテゴリーIDを基にジャンル一覧を取得
2. 画像付きジャンルボタンを表示
3. ユーザーがジャンルをクリック → パーツリストページへ遷移

#### データ構造（概念）
```yaml
Genre:
  識別子: id (自動生成)
  基本情報:
    - categoryId（必須）
    - name（必須）例: ENG ASSY
    - imageUrl（任意）Cloudinary URL
  メタ情報:
    - 作成日時
    - 更新日時
  関連:
    - Category（多対1）
    - Part（1対多）
```

---

### 3.4 P-004: パーツリストページ

#### 目的
ジャンル内のパーツ一覧を展開図とともに表示し、在庫状況を一目で把握する

#### 主要機能
- 展開図表示（大きな画像1枚、表示/非表示切り替え可能）
- パーツ一覧表示（テーブル形式）
- 各パーツ行に小さい画像表示（表示/非表示切り替え可能）
- 画像位置選択（左端または右端）

#### パーツリスト項目
| 項目 | 説明 |
|------|------|
| ユニット番号 | リスト内の割り振り番号（例: 4-1, 4-2） |
| 品番 | Part No. |
| 品名 | Part Name |
| 数量 | Units（必要数） |
| 在庫数量 | Stock Quantity（現在の在庫数、PartMasterから取得） |
| 備考 | 任意のメモ |
| 収納ケース番号 | 保管場所 |
| 発注日 | 発注した日付 |
| 入荷予定日 | 入荷予定の日付 |
| 画像 | パーツ画像（小）、左端または右端に配置 |

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | パーツ一覧取得 | ジャンルID | パーツ配列（在庫数含む） |
| 取得 | 展開図取得 | ジャンルID | 展開図画像URL |

#### 処理フロー
1. ジャンルIDを基にパーツ一覧と展開図を取得
2. 展開図を上部に表示（表示設定に応じて）
3. パーツ一覧をテーブル形式で表示
4. 各パーツ行に小さい画像を表示（表示設定に応じて）

#### データ構造（概念）
```yaml
Part:
  識別子: id (自動生成)
  基本情報:
    - genreId（必須）
    - unitNumber（必須）例: 4-1
    - partNumber（必須）品番
    - partName（必須）品名
    - quantity（必須）数量（必要数）
    - storageCase（任意）収納ケース番号
    - notes（任意）備考
    - orderDate（任意）発注日
    - expectedArrivalDate（任意）入荷予定日
    - imageUrl（任意）Cloudinary URL
  在庫情報:
    - stockQuantity（PartMasterから取得）現在の在庫数
  メタ情報:
    - 作成日時
    - 更新日時
  関連:
    - Genre（多対1）
    - PartMaster（多対1、partNumber経由）

PartMaster:
  識別子: id (自動生成)
  基本情報:
    - partNumber（必須、ユニーク）品番
    - stockQuantity（必須）在庫数
  メタ情報:
    - 作成日時
    - 更新日時
  関連:
    - Part（1対多、partNumber経由）

DiagramImage:
  識別子: id (自動生成)
  基本情報:
    - genreId（必須）
    - imageUrl（必須）Cloudinary URL
    - imageType（必須）'diagram'（展開図）
  メタ情報:
    - 作成日時
    - 更新日時
  関連:
    - Genre（多対1）
```

---

### 3.5 P-005: 検索ページ

#### 目的
収納ケース番号または品番で横断検索し、複数ジャンルにまたがるパーツを即座に発見する

#### 主要機能
- 収納ケース番号検索
- 品番検索
- 検索結果表示（ジャンル番号、リスト内番号、収納ケース番号）

#### 検索結果表示例
```
検索結果: 品番「35171RT10C」

1. ジャンル: 100 (ENG ASSY)
   リスト番号: 5-3
   収納ケース: A-12
   在庫数: 5個

2. ジャンル: 3205 (TRANSMISSION)
   リスト番号: 4-1
   収納ケース: B-05
   在庫数: 5個（同一品番のため自動同期）
```

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 検索 | 収納ケース番号検索 | 収納ケース番号 | 該当パーツ配列 |
| 検索 | 品番検索 | 品番 | 該当パーツ配列（複数ジャンルにまたがる） |

#### 処理フロー
1. ユーザーが検索タイプを選択（収納ケース番号 or 品番）
2. 検索ワードを入力
3. サーバーが全ジャンルを横断検索
4. 検索結果を一覧表示（ジャンル名、リスト番号、収納ケース番号、在庫数）

---

### 3.6 A-001: 管理ダッシュボード

#### 目的
全体状況を把握し、各管理機能へ素早くアクセスする

#### 主要機能
- 統計表示（カテゴリー数、ジャンル数、パーツ総数、在庫総数）
- クイックアクセスボタン（各管理ページへのリンク）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 統計情報取得 | なし | カテゴリー数、ジャンル数、パーツ総数、在庫総数 |

---

### 3.7 A-002: カテゴリー管理ページ

#### 目的
カテゴリーの追加、編集、削除、並び替えを行う

#### 主要機能
- カテゴリー一覧表示
- 新規追加フォーム
- 編集フォーム
- 削除ボタン
- 並び替え機能（ドラッグ&ドロップ）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | カテゴリー一覧取得 | なし | カテゴリー配列 |
| 作成 | カテゴリー追加 | カテゴリー名 | 作成されたカテゴリー |
| 更新 | カテゴリー編集 | カテゴリーID、新しいカテゴリー名 | 更新されたカテゴリー |
| 削除 | カテゴリー削除 | カテゴリーID | 削除完了メッセージ |
| 更新 | 並び替え | カテゴリーID配列（新しい順序） | 更新完了メッセージ |

---

### 3.8 A-003: ジャンル管理ページ

#### 目的
ジャンルの追加、編集、削除、並び替え、画像管理を行う

#### 主要機能
- ジャンル一覧表示（画像サムネイル付き）
- 新規追加フォーム（画像アップロード含む）
- 編集フォーム（画像差し替え含む）
- 削除ボタン
- 並び替え機能

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | ジャンル一覧取得 | カテゴリーID | ジャンル配列（画像URL含む） |
| 作成 | ジャンル追加 | カテゴリーID、ジャンル名、画像ファイル | 作成されたジャンル |
| 更新 | ジャンル編集 | ジャンルID、新しいジャンル名、画像ファイル（任意） | 更新されたジャンル |
| 削除 | ジャンル削除 | ジャンルID | 削除完了メッセージ（画像も自動削除） |

---

### 3.9 A-004: パーツリスト管理ページ

#### 目的
パーツの追加、編集、削除、一括操作、CSV/PDF出力を行う

#### 主要機能
- パーツ一覧表示（チェックボックス付き）
- 新規追加フォーム（画像アップロード、展開図アップロード含む）
- 編集フォーム（画像差し替え含む）
- 削除ボタン
- 一括削除（チェックボックス選択式）
- CSV一括インポート
- CSV/PDF エクスポート

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | パーツ一覧取得 | ジャンルID | パーツ配列（在庫数含む） |
| 作成 | パーツ追加 | ジャンルID、ユニット番号、品番、品名、数量、備考、収納ケース番号、発注日、入荷予定日、画像ファイル | 作成されたパーツ |
| 更新 | パーツ編集 | パーツID、更新データ | 更新されたパーツ |
| 更新 | 在庫数更新 | 品番、新しい在庫数 | 同一カテゴリー内の同一品番すべてに反映 |
| 削除 | パーツ削除 | パーツID | 削除完了メッセージ |
| 削除 | 一括削除 | パーツID配列 | 削除完了メッセージ |
| 作成 | CSV一括インポート | CSVファイル | インポート結果 |
| エクスポート | CSVエクスポート | ジャンルID | CSVファイルダウンロード |
| エクスポート | PDFエクスポート | ジャンルID | PDFファイルダウンロード（展開図+一覧表） |

---

### 3.10 A-005: 表示設定ページ

#### 目的
パーツリストページの画像表示をカスタマイズする

#### 主要機能
- 展開図表示切り替え（表示/非表示）
- パーツ画像表示切り替え（表示/非表示）
- 画像位置選択（左端/右端）

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 取得 | 表示設定取得 | なし | 現在の表示設定 |
| 更新 | 表示設定更新 | 展開図表示（ON/OFF）、パーツ画像表示（ON/OFF）、画像位置（left/right） | 更新完了メッセージ |

---

### 3.11 A-006: アカウント設定ページ

#### 目的
管理者のID（メールアドレス）とパスワードを変更する

#### 主要機能
- メールアドレス変更フォーム
- パスワード変更フォーム

#### 必要な操作
| 操作種別 | 操作内容 | 必要な入力 | 期待される出力 |
|---------|---------|-----------|---------------|
| 更新 | メールアドレス変更 | 新しいメールアドレス、現在のパスワード | 更新完了メッセージ |
| 更新 | パスワード変更 | 現在のパスワード、新しいパスワード | 更新完了メッセージ |

---

## 4. データ設計概要

### 4.1 主要エンティティ

```yaml
Admin:
  概要: 管理者アカウント
  主要属性:
    - email: メールアドレス
    - passwordHash: パスワードハッシュ（bcrypt）
  関連:
    - なし

Category:
  概要: 大カテゴリー（GT3-048など）
  主要属性:
    - name: カテゴリー名
  関連:
    - Genre（1対多）

Genre:
  概要: ジャンル（ENG ASSY、TRANSMISSION など）
  主要属性:
    - categoryId: 所属カテゴリー
    - name: ジャンル名
    - imageUrl: ジャンル画像URL（Cloudinary）
  関連:
    - Category（多対1）
    - Part（1対多）
    - DiagramImage（1対多）

Part:
  概要: パーツ情報
  主要属性:
    - genreId: 所属ジャンル
    - unitNumber: ユニット番号（4-1など）
    - partNumber: 品番
    - partName: 品名
    - quantity: 数量（必要数）
    - stockQuantity: 在庫数量（PartMasterから取得）
    - storageCase: 収納ケース番号
    - notes: 備考
    - orderDate: 発注日
    - expectedArrivalDate: 入荷予定日
    - imageUrl: パーツ画像URL（Cloudinary）
  関連:
    - Genre（多対1）
    - PartMaster（多対1、partNumber経由）

PartMaster:
  概要: 品番ごとの在庫数マスター（同一品番の在庫数を一元管理）
  主要属性:
    - partNumber: 品番（ユニーク）
    - stockQuantity: 在庫数
  関連:
    - Part（1対多、partNumber経由）

DiagramImage:
  概要: 展開図画像
  主要属性:
    - genreId: 所属ジャンル
    - imageUrl: 展開図画像URL（Cloudinary）
    - imageType: 画像タイプ（'diagram'固定）
  関連:
    - Genre（多対1）
```

### 4.2 エンティティ関係図
```
Admin（管理者）

Category（カテゴリー）─┬─ Genre（ジャンル）─┬─ Part（パーツ）
                      │                 ├─ DiagramImage（展開図）
                      │                 └─ PartMaster（在庫マスター）
                      │                      └─ Part（partNumber経由）
```

### 4.3 バリデーションルール
```yaml
email:
  - ルール: 有効なメール形式
  - 理由: ログインIDとして使用

passwordHash:
  - ルール: bcryptハッシュ、8文字以上の平文パスワード
  - 理由: セキュリティ確保

Category.name:
  - ルール: 必須、ユニーク、1-100文字
  - 理由: カテゴリーの一意性保証

Genre.name:
  - ルール: 必須、1-100文字
  - 理由: ジャンルの識別

Part.partNumber:
  - ルール: 必須、1-50文字
  - 理由: 品番の識別、在庫マスターとの紐付け

Part.storageCase:
  - ルール: 任意、1-50文字
  - 理由: 収納場所の識別

PartMaster.stockQuantity:
  - ルール: 必須、整数、0以上
  - 理由: 在庫数の正確性保証
```

---

## 5. 制約事項

### 外部API制限
- **Cloudinary無料プラン**: 月25GB転送、25GBストレージ
- **Neon無料プラン**: 0.5GBストレージ、月100時間CPU時間

### 技術的制約
- **画像サイズ制限**: 1ファイルあたり5MB
- **PDFサイズ制限**: 1ファイルあたり10MB
- **CSV一括インポート**: 1回あたり1000行まで

---

## 6. 複合API処理（バックエンド内部処理）

### 複合処理-001: 同一品番在庫数更新
**トリガー**: パーツリスト管理画面で在庫数を変更
**フロントエンドAPI**: PUT /api/parts/:partNumber/stock
**バックエンド内部処理**:
1. PartMasterテーブルの該当品番の在庫数を更新
2. トランザクション処理で整合性保証
3. React Queryのキャッシュ無効化で全画面に自動反映
**結果**: 同一カテゴリー内の同一品番すべての在庫数が自動更新
**外部サービス依存**: なし

### 複合処理-002: PDFエクスポート
**トリガー**: パーツリスト管理画面で「PDFエクスポート」ボタンクリック
**フロントエンドAPI**: GET /api/genres/:genreId/export/pdf
**バックエンド内部処理**:
1. ジャンル情報、展開図URL、パーツ一覧を取得
2. jsPDFまたはpdfmakeでPDF生成
3. 展開図画像を埋め込み
4. パーツ一覧表を生成
5. PDFファイルとして返却
**結果**: 展開図+パーツ一覧表を含むPDFファイルダウンロード
**外部サービス依存**: Cloudinary（画像取得）

### 複合処理-003: CSV一括インポート
**トリガー**: パーツリスト管理画面で「CSV一括インポート」ボタンクリック
**フロントエンドAPI**: POST /api/genres/:genreId/import/csv
**バックエンド内部処理**:
1. CSVファイルをPapa Parseで解析
2. バリデーション（品番、品名、数量等）
3. Prismaトランザクションで一括INSERT
4. PartMasterの在庫数を自動作成/更新
5. インポート結果を返却（成功数、失敗数）
**結果**: CSVデータがパーツリストに一括登録
**外部サービス依存**: なし

---

## 7. 技術スタック

```yaml
フロントエンド:
  - React 18: モダンなUI構築
  - TypeScript 5: 型安全性による品質保証
  - MUI v6: 統一されたデザインシステム
  - React Router v6: ルーティング管理
  - Zustand: 軽量グローバル状態管理
  - React Query: サーバー状態管理とキャッシング
  - Vite 5: 高速開発サーバー
  - react-pdf: PDF画像表示
  - Papa Parse: CSVエクスポート

バックエンド:
  - Node.js 20+ (TypeScript 5)
  - Express.js: RESTful API構築
  - Prisma ORM: 型安全なデータベース操作
  - bcrypt: パスワードハッシュ化
  - express-session: セッション管理
  - multer: 画像アップロード処理

データベース:
  - PostgreSQL 15+ (Neon - サーバーレス)

画像・ファイル保存:
  - Cloudinary: 画像・PDF保存、CDN配信

インフラ:
  - フロントエンド: Vercel（推奨）
  - バックエンド: Google Cloud Run（推奨）
  - データベース: Neon（組み込み済み）
```

---

## 8. 必要な外部サービス・アカウント

### 必須サービス
| サービス名 | 用途 | 取得先 | 備考 |
|-----------|------|--------|------|
| Cloudinary | 画像・PDF保存 | https://cloudinary.com/users/register_free | 無料プラン（25GB/月） |
| Neon | PostgreSQLデータベース | https://neon.tech | 無料プラン（0.5GB） |

---

## 9. 今後の拡張予定

**原則**: 拡張予定があっても、必要最小限の実装のみを行う

- 「あったらいいな」は実装しない
- 拡張可能性のための余分な要素は追加しない
- 将来の「もしかして」のための準備は禁止
- 今、ここで必要な最小限の要素のみを実装

拡張が必要になった時点で、Phase 11: 機能拡張オーケストレーターを使用して追加実装を行います。

### 拡張候補（実装はしない）
- マルチテナント対応（1アカウント = 1独立した在庫管理システム）
- サブスクリプション販売機能
- ユーザーロール追加（一般ユーザー、閲覧専用ユーザー等）
- 在庫アラート機能（在庫数が閾値以下で通知）
- 発注自動化機能
- 統計・分析ダッシュボード
- モバイルアプリ版

---

**作成日**: 2025-11-13
**バージョン**: 1.0.0
